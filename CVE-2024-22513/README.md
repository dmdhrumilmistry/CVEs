# CVE-2024-22513

The version of [djangorestframework-simplejwt](https://github.com/jazzband/djangorestframework-simplejwt) up to 5.3.1 (latest version) may be vulnerable if not used correctly. This potential issue can lead to various security concerns, including Business Object Level Authorization (BOLA), Business Function Level Authorization (BFLA), and Information Disclosure. These concerns primarily arise if developers do not follow the library's documentation and fail to use the provided modules and classes correctly.

## Potential Misuse

If a programmer generates a JWT token for an inactive user using the `AccessToken` class and `for_user` method without the proper user validation provided by the Token Obtain Serializers, a JWT token can be returned and used for authentication across the Django Rest Framework application. However, that token can only be used to access web application resources if the programmer does not use the provided `JWTAuthentication` backend and instead writes their own custom authentication code without checking if the user account has been disabled.

- Start Django shell

```bash
python manage.py shell
```

- Create an inactive user and generate a token for the user without using the validation code provided by the library

```python
from django.contrib.auth.models import User
from rest_framework_simplejwt.tokens import AccessToken

# create inactive user
inactive_user_id = User.objects.create_user('testuser', 'test@example.com', 'testPassw0rd!', is_active=False).id

# django application programmer generates token for the inactive user manually
AccessToken.for_user(User.objects.get(id=inactive_user_id))  # a warning could be raised since the user is inactive

# django application manually verifying user token
AccessToken.for_user(User.objects.get(id=inactive_user_id)).verify()  # a warning could be raised since the user is inactive
```

## Impact

The impact of improper usage varies from application to application and the custom code written.
The general concerns are that if a programmer doesn't use the modules and classes provided by the library to validates a user before generating a token and to authenticate the user using a token, then it could lead to:

- Bypass of Account Deactivation:
    Generating a JWT token for an inactive user without proper checks could allow an attacker to use this token for authentication, bypassing account deactivation.

- Authentication Bypass:
    An attacker could authenticate requests to the Django and Django Rest Framework applications using the token for an inactive user, leading to unauthorized access to protected resources.

- Authorization Issues:
    Without proper validation, an attacker with a token for an inactive user might access functionalities or data they shouldn't, causing Business Object Level Authorization (BOLA) issues.

- Information Disclosure:
    Authenticating as an inactive user could lead to information disclosure if certain resources or endpoints should only be accessible to active users.

## Mitigation

To prevent potential security risks, ensure you use one of the provided Token Obtain Serializers to generate tokens and the provided `JWTAuthentication` to authenticate the user. If you are writing custom serializers and authentication backends, ensure there is a thorough verification process to determine whether the user is active or not. This validation step is essential in preventing unauthorized access and helps mitigate the vulnerability associated with the lack of user inactivity validation in the mentioned functionality. Implementing this check adds an extra layer of security to your application.

```python
from django.contrib.auth.models import User
from rest_framework_simplejwt.tokens import AccessToken

user = User.objects.get(id=inactive_user_id)

if user and user.is_active:
    token = AccessToken.for_user(user)
```

## Additional Information

A feature was introduced in a [Pull Request](https://github.com/jazzband/djangorestframework-simplejwt/pull/776) on the Django Rest Framework SimpleJWT GitHub repository, allowing the use of different subclasses of the `Token` class with the `for_user` method. However, this enhancement expands the potential attack surface if not used correctly.

Projects on [GitHub](https://github.com/search?q=%28%22RefreshToken.for_user%28%22+OR+%22AccessToken.for_user%28%22%29+language%3Apython&type=code&p=2) that utilize this functionality without proper user inactivity validation could pose a security risk, leading to unauthorized access if custom serializers and authentication backends are written.

The documentation does not currently provide security warnings about the potential risks associated with the new feature, which could lead developers to inadvertently expose their projects to security vulnerabilities if custom code that doesn't validate the user is written.

- https://django-rest-framework-simplejwt.readthedocs.io/en/latest/rest_framework_simplejwt.html#module-rest_framework_simplejwt.tokens
- https://django-rest-framework-simplejwt.readthedocs.io/en/latest/rest_framework_simplejwt.html#rest_framework_simplejwt.tokens.Token.for_user
